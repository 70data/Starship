# Tools

Shell (and other scripts) related to maintaining codebase.
See the comment of the script file for more details.

## Tools instructions

* `ansible`: Ansible playbooks
* `aws`: AWS tools
* `chef`: Chef recipes
* `cleanup.sh`: Run before pushing PR, which invokes all necessary cleanup tools
* `docker`: Docker build files
* `docker_compose`: Docker compose
* `http-echo`: http-echo demo app
* `skaffold`: `skaffold -f tools/skaffold.yaml` to build and deploy API server
  and agents without other parts of Starship
* `scripts`: Various scripts

## Cleanup.sh

`cleanup.sh` will automatically generate `BUILD.bazel` for new Golang source
files. When adding new golang source file. Remember to run this to generate the
corresponding build targets.

`cleanup.sh` calls `:gazelle` to generate `BUILD.bazel`, but gazelle can only
process dependencies inferred from imported modules in Go source files. Gazelle
cannot generate build dependencies for runtime dependencies, like `data` deps.
In such cases, you need to manually add them to BUILD.bazel.

## Build and push dev images

```
cd chef/
make build_and_push_dev_images
```

This make command builds 3 images:
* base_dev_image
* dev_image
* dev_image_with_extras

The `dev_image_with_extras`'s full registry/repository:tag is written to
`$(TOT)/tools/docker/dev_image/DEV_IMAGE`, and is read by
tools/docker/dev_image/run.sh to launch the dev image container.

## Notes

### Generated go proto source files

These are used by IDEs to index the Go source code. Bazel gazelle also ignores
the imports prefixed by the local workspace, so they do not consider these
generated Go source files either.

### Get BUILD file content of a rule

```
bazel query --noimplicit_deps <BUILD_RULE> --output=build
diff -Naur
```

Note the output is different form the raw BUILD.bazel file generated by bazel.

### Cgo + CC library

https://rotemtam.com/2020/10/30/bazel-building-cgo-bindings/

Patching does not work as expected, as the `bazel qeury --output=build`'s output
does not match the actual BUILD.bazel file, and have to look at the generated
BUILD.bazel file and make the patch manually.

The generated `BUILD.bazel` for `@com_github_iovisor_gobpf//bcc` is located at:
```
bazel-starship/external/com_github_iovisor_gobpf/bcc/BUILD.bazel
# Use diff to generate a patch
diff -Naru ~/tmp/gobpf_bcc_BUILD.bazel.{orig,updated} >bazel/go_bcc_BUILD.patch
```

### bazel query

https://docs.bazel.build/versions/main/query-how-to.html

Find the build rule that has a file as srcs:

```
fullname=$(bazel query @llvm-project//llvm:lib/ExecutionEngine/MCJIT/MCJIT.cpp)
bazel query "attr('srcs', $fullname, ${fullname//:*/}:*)"
```

### Patching `BUILD.bazel` of `go_repository()` rule

Find the `BUILD.bazel` file of the target directory.
Under `$(bazel info output_base)/external/<go_repository() rule name>/<replative path>/BUILD.bazel`.
Copy that BUILD.bazel file to another directory, and create another copy:

```
cp <build_file> ~/tmp/BUILD.bazel
cp <build_file> ~/tmp/BUILD2.bazel
diff -aur ~/tmp/BUILD.bazel ~/tmp/BUILD2.bazel >BUILD.bazel.patch
# Edit BUILD.bazel.patch, change the title file path to the relative path from the base of
# go_repository()
```

Then update the `go_repository()` to add:

```
patches = ["//:bazel/BUILD.bazel.patch"],
```

## BuildBuddy bazel cache

Forward bazel build artifacts to buildbuddy for caching. To avoid repeating
builds when the cache is not readily available. For example, protocol buffer
don't need to be rebuilt each time on Github Action.

BuildBuddy remote bazel cache is only enabled on github action, not local builds.
Since local builds with BuildBuddy is much slower because of the need to upload and download build artifacts.
